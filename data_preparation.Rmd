---
title: "data preparation"
author: "Frederik Heitm√ºller"
date: "8 September 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require('XML')) install.packages('XML'); library('XML') 
if (!require('pdftools')) install.packages('pdftools'); library('pdftools') 
if (!require('tabulizer')) install.packages('tabulizer'); library('tabulizer') 
if (!require('rJava')) install.packages('rJava'); library('rJava')
if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if (!require('magrittr')) install.packages('magrittr'); library('magrittr')
if (!require('countrycode')) install.packages('countrycode'); library('countrycode')

```

# Content

This file contains the major data operation carried out to clean and transform the files used in the SEZ project.

## EU Code of Conduct

Data regarding the work of the EU Code of Conduct Group can be obtained from the website of the European Council under <https://data.consilium.europa.eu/doc/document/ST-9639-2018-REV-4/en/pdf>.


```{r Code of Conduct}

file <- "https://data.consilium.europa.eu/doc/document/ST-9639-2018-REV-4/en/pdf"

out <- extract_tables(file, pages = c(4:95), columns=list(c(5, 10, 20, 30)), method = "stream", encoding="UTF-8", output="matrix")

columnnames <- c("country", "regime", "standstill", "assessment", "rollback")
for (i in c(1:44, 46:90)){
  out[[i]]<- as.data.frame(out[[i]])
  p <- ncol(out[[i]])
   if (p==5){
     colnames(out[[i]])<- columnnames
   }
  if (p==4){
   out[[i]] %<>% add_column(.before=1, country=NA)
colnames(out[[i]])<- columnnames
}
    if(p==3){
      out[[i]] %<>% add_column(.before=1, country=NA)
         out[[i]] %<>% add_column(.after=4, rollback=NA)
         colnames(out[[i]])<- columnnames

    }
     }

for (i in c(45,91)){
    out[[i]]<- as.data.frame(out[[i]])
    out[[i]] %<>% add_column(.after=4, rollback=NA)
    colnames(out[[i]])<- columnnames

}
 
cc_regimes <- as.data.frame(do.call(rbind, out))

cc_regimes<- cc_regimes[-c(1:3, 991:993, 1233:1242),] #removing former headings from table
cc_regimes <- as.data.frame(lapply(cc_regimes, trimws), stringsAsFactors = FALSE) 
pl <- which(nchar(cc_regimes$standstill)==4, arr.ind=TRUE) #taking all the lines where a standstill date is entered as principal lines

cc_regimes <- transformpdftbl::t_pdf_tbl(cc_regimes, pl)

#transformations

##extracting the country identifier (eurostat schema)
cc_regimes %<>% mutate(eurostat= substr(regime, start = 1, stop = 2))
## removing country column
cc_regimes %<>% select(-country)
##separating the information from various columns
cc_regimes %<>% separate(col=standstill, into=c("standstill_year", "institution"), sep=5)  
cc_regimes %<>% separate(col=regime, into=c("identifier", "regime_name"), sep=6)
cc_regimes %<>% separate(col=regime_name, into=c("rest", "regime_name"), sep='"')
cc_regimes %<>% select(-rest)
cc_regimes %<>% separate(col=assessment, into=c("assessment", "document"), sep=" \\(doc.")
cc_regimes %<>% mutate(assessment = str_replace_all(assessment,"15", ""))
cc_regimes %<>% mutate(assessment = str_replace_all(assessment,"HARMFUL", "Harmful"))

cc_regimes$document <- str_replace(cc_regimes$document, "\\)", "")
cc_regimes$document <- str_replace(cc_regimes$document, ". ", "")
cc_regimes %<>% mutate(rollback= str_replace_all(rollback,"NA",""))
cc_regimes %<>% mutate(institution = str_replace_all(institution,"\\(", ""))
cc_regimes %<>% mutate(institution = str_replace_all(institution,"\\)", ""))
cc_regimes %<>% mutate_all(trimws)
cc_regimes  %<>% mutate(institution = na_if(institution,"")) %<>% mutate(institution = str_replace_na(institution, "COCG"))
cc_regimes$iso3c <- countrycode(cc_regimes$eurostat, origin="eurostat", destination="iso3c")
for (i in 1:nrow(cc_regimes)){
if (cc_regimes$eurostat[i]=="AN"){cc_regimes$iso3c[i] <- "BES"}
  if (cc_regimes$eurostat[i]=="NA"){cc_regimes$iso3c[i] <- "NAM"}
  }
write_csv2(cc_regimes, "data_prepared/cc_regimes.csv")
saveRDS(cc_regimes, "data_prepared/cc_regimes.rds")
```